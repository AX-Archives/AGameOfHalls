<script>
  // Elements
  const playButton = document.getElementById('play-button');
  const versionLinks = document.querySelectorAll('.versions-scroll a');
  const gameContainer = document.getElementById('game-container');
  const gameFrame = document.getElementById('game-frame');
  const closeGameBtn = document.getElementById('close-game');

  // Handle version selection
  versionLinks.forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();

      // Clear other selections
      versionLinks.forEach(v => v.classList.remove('selected'));
      link.classList.add('selected');

      // Enable play button
      const file = link.getAttribute('href');
      const versionText = link.textContent.replace("AGoH ", "");
      playButton.classList.remove('disabled');
      playButton.setAttribute('aria-disabled', 'false');
      playButton.dataset.file = file;
      playButton.textContent = `Play Selected Version ${versionText}`;
    });
  });

  // Play button: load and fullscreen game
  playButton.addEventListener('click', async e => {
    e.preventDefault();
    if (playButton.classList.contains('disabled')) return;

    const file = playButton.dataset.file;
    if (!file) return;

    // Load game
    gameFrame.src = file;
    gameContainer.classList.remove('hidden');
    gameContainer.setAttribute('aria-hidden', 'false');

    // Try to immediately fullscreen
    try {
      await gameContainer.requestFullscreen();
      gameContainer.classList.add('fullscreen');
    } catch (err) {
      console.warn("Fullscreen request failed, fallback to docked:", err);
      gameContainer.classList.remove('fullscreen');
    }
  });

  // Close game
  closeGameBtn.addEventListener('click', () => {
    gameContainer.classList.add('hidden');
    gameContainer.setAttribute('aria-hidden', 'true');
    gameFrame.src = ''; // stop game
    if (document.fullscreenElement) {
      document.exitFullscreen().catch(() => {});
    }
    gameContainer.classList.remove('fullscreen');
  });

  // Toggle fullscreen on F10
  document.addEventListener('keydown', async e => {
    if (e.key === 'F10' || e.keyCode === 121) {
      e.preventDefault();
      if (gameContainer.classList.contains('hidden')) return;

      try {
        if (!document.fullscreenElement) {
          await gameContainer.requestFullscreen();
          gameContainer.classList.add('fullscreen');
        } else {
          await document.exitFullscreen();
          gameContainer.classList.remove('fullscreen');
        }
      } catch (err) {
        console.error("Fullscreen toggle failed:", err);
        gameContainer.classList.toggle('fullscreen');
      }
    }
  });

  // Sync CSS class if user exits fullscreen manually
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      gameContainer.classList.remove('fullscreen');
    }
  });

  // Auto-refresh if site changes
  let cachedHTML = null;
  async function checkWebsiteUpdate() {
    try {
      const resp = await fetch(window.location.href, { cache: "no-store" });
      const text = await resp.text();
      if (cachedHTML && cachedHTML !== text) {
        location.reload();
      }
      cachedHTML = text;
    } catch (err) {
      console.error("Update check failed:", err);
    }
  }
  setInterval(checkWebsiteUpdate, 1000);

  // Accessibility: Enter key selects versions
  versionLinks.forEach(a => {
    a.setAttribute('tabindex', '0');
    a.addEventListener('keypress', ev => {
      if (ev.key === 'Enter') a.click();
    });
  });
</script>
